---
title: "Homework 6"
author: "Alice Tivarovsky"
date: "11/16/2019"
output: html_document
---

Setup code: 

```{r setup}
library(tidyverse)
library(modelr)
library(MASS)

set.seed(1)

knitr::opts_chunk$set(
	echo = TRUE,
	warning = FALSE,
  out.width = "90%"
)
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)
scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
theme_set(theme_minimal() + theme(legend.position = "bottom"))

```

## Problem 1

Loading and tidying data: 

```{r}
bwt_data = 
  read_csv("./data/birthweight.csv") %>% 
  mutate(
    babysex = as_factor(babysex),
    frace = as_factor(frace),
    malform = as_factor(malform), 
    mrace = as_factor(mrace)
  ) 

```
The resulting dataset contains 4342 observations across 20 variables. Numerical  variables were converted to categorical variables based on the data dictionary using as_factor. 

Checking for missing values using purrr: 
```{r}
bwt_data %>% 
  map_df(~sum(is.na(.)))
```

We confirm there are no missing values in the dataset. 

Next, we hypothesize that birthweight can be modeled with predictors `blength` (baby's length at birth), `gaweeks` (gestational age in weeks), `fincome` (family monthly income), `pnumlbw` (previous number of low birthweight babies) and `smoken` (average number of cigarettes smoked per day during pregnancy). 

```{r}

model_1 = 
  bwt_data %>%  
  lm(bwt ~ blength + gaweeks + fincome + pnumlbw + smoken, data = .) 

bwt_data %>% 
  add_residuals(model_1) %>% 
  add_predictions(model_1) %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point()


```

Using all_possible_regression: 

```{r}
ols_model = 
  bwt_data %>%  
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + frace + gaweeks + malform + menarche + mheight + momage + mrace + parity + pnumlbw + pnumsga + ppbmi + ppwt + smoken + wtgain, data = .) 

```

Using AIC: 

```{r}
full_model = lm(bwt ~. , data = bwt_data)

stepAIC(full_model, direction = "both")
  
```

AIC analysis concludes that variables babysex, bhead, blength, delwt, fincome, gaweeks, mheight, mrace, parity, ppwt, and smoken belong in the model. Using this model: 

```{r}
aic_model = 
  bwt_data %>%  
  lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken, data = .) 

bwt_data %>% 
  add_residuals(aic_model) %>% 
  add_predictions(aic_model) %>% 
  ggplot(aes(x = pred, y = resid)) + 
  geom_point()

```

### Cross Validation

Creating testing and training datasets: 

```{r}
cv_bwt = 
  crossv_mc(bwt_data, 100) 
```

Fitting candidate models: 

```{r}

cv_bwt = 
  cv_bwt %>% 
  mutate(model_a = map(train, ~lm(bwt ~ blength + gaweeks, data = .x)),
         model_b = map(train, ~lm(bwt ~ bhead + blength + babysex + bhead*blength + bhead*babysex + blength*babysex + blength*babysex*bhead, data = .x)),
         aic_model = map(train, ~lm(bwt ~ babysex + bhead + blength + delwt + fincome + gaweeks + mheight + mrace + parity + ppwt + smoken, data = .))
  ) %>% 
  mutate(rmse_a = map2_dbl(model_a, test, ~rmse(model = .x, data = .y)),
         rmse_b = map2_dbl(model_b, test, ~rmse(model = .x, data = .y)),
         rmse_aic = map2_dbl(aic_model, test, ~rmse(model = .x, data = .y))) 
         
```  

CV Plots: 
```{r}
error_plot = 
  cv_bwt %>% 
  dplyr::select(rmse_a) 

```



# Problem 2

```{r}
weather_df = 
  rnoaa::meteo_pull_monitors(c("USW00094728", "USC00519397", "USS0023B17S"),
                      var = c("PRCP", "TMIN", "TMAX"), 
                      date_min = "2017-01-01",
                      date_max = "2017-12-31") %>%
  mutate(
    name = recode(id, USW00094728 = "CentralPark_NY", 
                      USC00519397 = "Waikiki_HA",
                      USS0023B17S = "Waterhole_WA"),
    tmin = tmin / 10,
    tmax = tmax / 10) %>%
  dplyr::select(name, id, everything())
weather_df
```

Drawing bootstrap samples: 


```{r}
boot_weather = 
  weather_df %>% 
  modelr::bootstrap(n = 100) %>% 
  mutate(
    models = map(strap, ~lm(tmax ~ tmin, data = .x)),
    results = map(models, broom::tidy), 
    glance = map(models, broom::glance)) %>% 
  dplyr::select(results, glance) %>% 
  unnest(results, glance) %>% 
  dplyr::select(term,estimate) %>% 
  pivot_wider(
    names_from = term, 
    values_from = estimate)  %>% 
  unnest() %>% 
  janitor::clean_names() %>% 
  mutate(log_est = intercept * tmin)
  

```



